---
title: "Workflow diagram"
author: "Julia BLanchard/ Ezekiel Adekoya"
date: "2025-01-31"
output:
   github_document:
    toc: true
    html_preview: false
---

# Mizer model workflow
In this notebook, we will create a diagram for the workflow that is being undertaken to explore top-down drivers in a mizer model of the Eastern Scotian Shelf.

## Loading libraries
  
```{r, warning = F}
## Load required libraries ----
# DiagrammeR: to create and render diagrams
# DiagrammeRsvg and rsvg: to export diagrams into image formats
library(DiagrammeR)
library(DiagrammeRsvg)
library(rsvg)
```
## Designing workflow

```{r}
## Create the workflow diagram ----

p <- grViz("digraph workflow {
  
  # Graph-wide settings
  graph [
    rankdir = TB         # Top-to-bottom layout
    bgcolor = 'white'    # White background
    nodesep = 0.5        # Space between nodes
    ranksep = 0.8        # Vertical space between ranks
    splines = ortho      # Orthogonal edges (square bends)
  ]
  
  # Default style for all nodes
  node [
    shape = rectangle
    style = ' '
    fillcolor = 'white'
    fontname = 'Helvetica,Arial,sans-serif'
    fontsize = 35
    width = 5
    penwidth = 4
  ]
  
  # Default style for edges
  edge [
    fontname = 'Helvetica,Arial,sans-serif'
    fontsize = 35
    width = 5
    penwidth = 4
    color = 'black'
  ]
  
  # Step 1: Load time series data
  Step_1 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 1: Get Time Series Data</b></td></tr>
    <tr><td bgcolor='white'>
      • Species abundance, biomass, and size distributions<br/>
      • Fisheries catch and effort data
    </td></tr>
  </table>>]
  
  # Step 2: Obtain species biological parameters
  Step_2 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 2: Get Species Parameters</b></td></tr>
    <tr><td bgcolor='white'>
      • Species life history traits (FishBase)<br/>
      • Predator-prey body size (Food Habits Database)
    </td></tr>
  </table>>]
  
  # Step 3: Calibrate the baseline steady-state model
  Step_3 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 3: Calibrate Steady State Baseline Model</b></td></tr>
    <tr><td bgcolor='white'>
      • Calibration of model steady state to time-averaged reference period<br/>
      • Match biomasses, yields, sensitivity to fishing
    </td></tr>
  </table>>, width = 10, height=0.3, pos = '0,0!']
  
  # Step 4: Check diagnostics
  Step_4 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 4: Steady State Diagnostics</b></td></tr>
    <tr><td bgcolor='white'>
      • Check diagnostic plots (biomasses, yields, growth curves, diets)<br/>
      • Check if outputs meet skill criteria
    </td></tr>
  </table>>, width = 10, height=0.3, pos = '0,-10!']
  
  # Decision point: Pass skill criteria?
  Step_n [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='16'>
    <tr><td bgcolor='lightgray'><b> Pass Skill Criteria? </b></td></tr>
  </table>>, shape = diamond, width = 5, height = 4, pos = '1,-2!']
  
  # Step 5: Run forcing scenarios
  Step_5 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 5: Dynamical Top-Down Forcing Scenarios</b></td></tr>
    <tr><td bgcolor='white'>
      • Scenario 1: Fishing effort time series (1970–2010)<br/>
      • Scenario 2: Additional hypothesized predation mortality (1986–2010)
    </td></tr>
  </table>>, pos = '0,-4!']
  
  # Step 6: Simulate scenarios with randomized interactions
  Step_6 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 6: Run Models with Randomized Interactions</b></td></tr>
    <tr><td bgcolor='white'>
      • Project model simulations (1970–2010) under two scenarios<br/>
      • Run 1000 randomized interaction matrices for each scenario
    </td></tr>
  </table>>, pos = '2,-4!']
  
  # Step 7: Compare model results and assess skill
  Step_7 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 7: Assess and Compare Model Skill Metrics</b></td></tr>
    <tr><td bgcolor='white'>
      • Compare scenarios: biomasses, catches, size distribution
    </td></tr>
  </table>>, width = 10, height=0.3, pos = '1,-6!']
  
  # Workflow connections
  Step_1 -> Step_2
  Step_2 -> Step_3
  Step_3 -> Step_4
  Step_4 -> Step_n
  
  # If diagnostics pass, move forward
  Step_n -> Step_5 [label = 'Yes', fontsize = 35, tailport = 's', headport = 'n']
  
  # If diagnostics fail, go back to calibration
  Step_n -> Step_3 [
    fontsize = 35, 
    constraint = true, 
    tailport = 'ws', 
    headport = 's', 
    minlen = 5, 
    xlabel = 'No',
    splines = 'true',  # Curved arrow
    width = 5,
    color = 'black'
  ]
  
  Step_5 -> Step_6
  Step_6 -> Step_7
}")

# Render the diagram in the RStudio Viewer
p

```
 

We can now save it as an `svg` image, but first we need to transform from the original HTML format.  
  
```{r, eval = FALSE}

## Save workflow diagram as an image ----
# Convert diagram to SVG format
svg_code <- export_svg(p)

# Save as PNG image
rsvg_png(charToRaw(svg_code), file = "Ess_Output/workflow.png")

# Save as PDF (you accidentally labeled it as .jpeg; fixed below)
#rsvg_pdf(charToRaw(svg_code), file = "Ess_Output/workflow.pdf")
```
  

```{r}

```

  
  







