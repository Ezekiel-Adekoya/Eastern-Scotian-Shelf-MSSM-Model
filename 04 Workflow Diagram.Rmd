---
title: "Workflow diagram"
author: "Julia BLanchard/ Ezekiel Adekoya"
date: "2025-01-31"
output:
   github_document:
    toc: true
    html_preview: false
---

# Mizer model workflow
In this notebook, we will create a diagram for the workflow that is being undertaken to explore top-down drivers in a mizer model of the Eastern Scotian Shelf.

## Loading libraries
  
```{r, warning = F}
library(DiagrammeR)
library(DiagrammeRsvg)
library(rsvg)
```

## Designing workflow
  
```{r}
p <- grViz("digraph git_basics {
graph [
      margin = '0,0'
      newrank = true
      nodesep = 0.6
      ranksep = 1.2
      overlap = false
      rankdir = TB
      bgcolor = 'white'
      splines = ortho
      ]
      
node [
      shape = rectangle
      style = filled
      fillcolor = 'white'
      fontname = 'Helvetica,Arial,sans-serif'
      fontsize = 35
      width = 5
      penwidth = 2
      ]
      
edge [
      fontname = 'Helvetica,Arial,sans-serif'
      fontsize = 35
      labelfontcolor = '#2F4F4F'
      penwidth = 2
      color = '#2F4F4F'
      shape = 'record'
      ]

# Define nodes in two columns to force alignment
subgraph column1 {
  Step_1[label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='28'>
			<tr> <td bgcolor = '#E6EEF7'> <b>Step 1: Get Time Series Data </b><br/></td> </tr>
			<tr> <td bgcolor = '#F5F8FC'>
<br/>
			• Surveyed species' abundance, biomass, and size distributions<br/>
• Fisheries catch and effort data
<br/>
			</td> </tr>
		</table>>]
  Step_5 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='28'>
			<tr> <td bgcolor = '#E6EEF7'> <b>Step 5: Dynamical Top-Down Forcing Scenarios</b><br/></td> </tr>
			<tr> <td bgcolor = '#F5F8FC'>
<br/>
			• Scenario 1: Fishing mortality time series (1970-2010)<br/>
• Scenario 2: Additional hypothesized seal mortality (1986-2010)
<br/>
			</td> </tr>
		</table>>]
}

subgraph column2 {
  Step_2 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='28'>
			<tr> <td bgcolor = '#E6EEF7'> <b>Step 2: Get Species Parameters</b><br/></td> </tr>
			<tr> <td bgcolor = '#F5F8FC'><br/>
			• Species life history traits (FishBase)<br/>
• Predator-prey body size (Food Habits Database)
<br/>
			</td> </tr>
		</table>>]
  Step_6 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='28'>
			<tr> <td bgcolor = '#E6EEF7'> <b>Step 6: Run Models with Randomized Interactions</b><br/></td> </tr>
			<tr> <td bgcolor = '#F5F8FC'>
<br/>
			• Project model simulations (1970-2010) under two scenarios<br/>
• Run 1000 randomized interaction matrices for each scenario
<br/>
			</td> </tr>
		</table>>]
}

subgraph column3 {
  Step_3 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='28'>
			<tr> <td bgcolor = '#E6EEF7'> <b>Step 3: Calibrate Steady State Baseline Model</b><br/></td> </tr>
			<tr> <td bgcolor = '#F5F8FC'>
<br/>
			• Calibration of model steady state to time-averaged reference period<br/>
• Scale model to observations<br/>
• Match biomasses<br/>
• Sensitivity to fishing<br/>
• Match yields
<br/>
			</td> </tr>
		</table>>]
  Step_7 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='28'>
			<tr> <td bgcolor = '#E6EEF7'> <b>Step 7: Assess and Compare Model Skill Metrics</b><br/></td> </tr>
			<tr> <td bgcolor = '#F5F8FC'>
<br/>
• Calculate model skill metrics against observations<br/>
• Compare scenarios for:<br/>
  - Species biomasses<br/>
  - Community aggregates<br/>
  - Catches and body size
<br/>
			</td> </tr>
		</table>>]
}

Step_4 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='28'>
			<tr> <td bgcolor = '#E6EEF7'> <b>Step 4: Steady State Diagnostics</b><br/></td> </tr>
			<tr> <td bgcolor = '#F5F8FC'>
• Check diagnostic plots and outputs meet skill criteria<br/>
• Biomasses within 10% of observations<br/>
• Fishery yields within 20% of observations<br/>
• Growth curves<br/>
• Emergent diets broadly captured
<br/>
			</td> </tr>
		</table>>]

Step_n [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='20'>
			<tr><td bgcolor = '#DAE8FC'><b>Pass Skill Criteria?</b></td></tr>
		</table>> fontsize = 38]

# First row alignment
{
  rank = same;
  Step_1 -> Step_2 -> Step_3 -> Step_4 [weight = 2];
}

# Second row alignment
{
  rank = same;
  Step_5 -> Step_6 -> Step_7 [weight = 2];
}

# Vertical alignment
{
  rank = same;
  Step_1;
  node1 [shape=point, width=0, style=invis];
}

{
  rank = same;
  Step_5;
  node2 [shape=point, width=0, style=invis];
}

# Force vertical alignment
node1 -> node2 [style=invis, weight=10];

# Vertical connections
Step_4 -> Step_n [weight = 1];
Step_n -> Step_5 [label = '  Yes  ' style = solid penwidth = 2 fontsize = 35
                  fontname = 'Helvetica,Arial,sans-serif' color = '#2F4F4F'];
Step_n -> Step_3 [label = '  No  ' style = solid penwidth = 2 fontsize = 35
                  fontname = 'Helvetica,Arial,sans-serif' color = '#2F4F4F'];

}",
width = "100%", height = "100%")

p
```
```{r}
p <- grViz("digraph workflow {
  # Graph settings
  graph [
    rankdir = TB
    bgcolor = 'white'
    nodesep = 0.3
    ranksep = 0.8
    splines = ortho
  ]
  
  # Node styles
  node [
    shape = rectangle
    style = ' '
    fillcolor = 'white'
    fontname = 'Helvetica,Arial,sans-serif'
    fontsize = 35
    width = 5
    penwidth = 3
  ]
  # Edge styles
  edge [
    fontname = 'Helvetica,Arial,sans-serif'
    fontsize = 35
    width = 5
    penwidth = 3
    color = 'black'
  ]
  # Define the nodes with HTML tables to preserve details
  Step_1 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 1: Get Time Series Data</b></td></tr>
    <tr><td bgcolor='white'>
      • Surveyed species' abundance, biomass, and size distributions<br/>
      • Fisheries catch and effort data
    </td></tr>
  </table>>]
  
  Step_2 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 2: Get Species Parameters</b></td></tr>
    <tr><td bgcolor='white'>
      • Species life history traits (FishBase)<br/>
      • Predator-prey body size (Food Habits Database)
    </td></tr>
  </table>>]
  
  Step_3 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 3: Calibrate Steady State Baseline Model</b></td></tr>
    <tr><td bgcolor='white'>
      • Calibration of model steady state to time-averaged reference period<br/>
      • Match biomasses, yields, sensitivity to fishing <br/>
    </td></tr>
   </table>>, width = 10, height=0.3]
  
  Step_4 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 4: Steady State Diagnostics</b></td></tr>
    <tr><td bgcolor='white'>
      • Check diagnostic plots (biomasses, yields, growth curves, diets)<br/>
      • Check if outputs meet skill criteria <br/>
    </td></tr>
 </table>>, width = 10, height=0.3]
  
  Step_n [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='16'>
    <tr><td bgcolor='lightgray'><b> Pass Skill Criteria? </b></td></tr>
  </table>>, shape = diamond, width = 3, height = 3]
  
  Step_5 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 5: Dynamical Top-Down Forcing Scenarios</b></td></tr>
    <tr><td bgcolor='white'>
      • Scenario 1: Fishing mortality time series (1970-2010)<br/>
      • Scenario 2: Additional hypothesized seal mortality (1986-2010)
    </td></tr>
  </table>>]
  
  Step_6 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 6: Run Models with Randomized Interactions</b></td></tr>
    <tr><td bgcolor='white'>
      • Project model simulations (1970-2010) under two scenarios<br/>
      • Run 1000 randomized interaction matrices for each scenario
    </td></tr>
  </table>>]
  Step_7 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 7: Assess and Compare Model Skill Metrics</b></td></tr>
    <tr><td bgcolor='white'>
      • Compare scenarios: biomasses, catches, size distribution<br/>
    </td></tr>
  </table>>, width = 10, height=0.3]
  
  # Connect the nodes vertically
  Step_1 -> Step_2
  Step_2 -> Step_3
  Step_3 -> Step_4
  Step_4 -> Step_n
  
  # Fixed arrows with better routing
  Step_n -> Step_5 [label = 'Yes' fontsize = 35, tailport = 's', headport = 'n']
  
  # Create a better loop back path
Step_n -> Step_3 [fontsize = 35, 
                  constraint = false, 
                  tailport = 'ws', 
                  headport = 's', 
                  minlen = 1, 
                  xlabel = 'No ',
                  splines = 'true',  # Enable curved arrow
                  color = 'black']
                  
                  
  Step_5 -> Step_6
  Step_6 -> Step_7
}")

p
```

```{r}
p <- grViz("digraph workflow {
  # Graph settings
  graph [
    rankdir = TB
    bgcolor = 'white'
    nodesep = 0.5
    ranksep = 0.8
    splines = ortho
  ]
  
  # Node styles
  node [
    shape = rectangle
    style = ' '
    fillcolor = 'white'
    fontname = 'Helvetica,Arial,sans-serif'
    fontsize = 35
    width = 5
    penwidth = 4
  ]
  
  # Edge styles
  edge [
    fontname = 'Helvetica,Arial,sans-serif'
    fontsize = 35
    width = 5
    penwidth = 4
    color = 'black'
  ]
  
  # Define the nodes with HTML tables to preserve details
  Step_1 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 1: Get Time Series Data</b></td></tr>
    <tr><td bgcolor='white'>
      • Species abundance, biomass, and size distributions<br/>
      • Fisheries catch and effort data
    </td></tr>
  </table>>]
  
  Step_2 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 2: Get Species Parameters</b></td></tr>
    <tr><td bgcolor='white'>
      • Species life history traits (FishBase)<br/>
      • Predator-prey body size (Food Habits Database)
    </td></tr>
  </table>>]
  
  Step_3 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 3: Calibrate Steady State Baseline Model</b></td></tr>
    <tr><td bgcolor='white'>
      • Calibration of model steady state to time-averaged reference period<br/>
      • Match biomasses, yields, sensitivity to fishing <br/>
    </td></tr>
  </table>>, width = 10, height=0.3, pos = '0,0!']
  
  Step_4 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 4: Steady State Diagnostics</b></td></tr>
    <tr><td bgcolor='white'>
      • Check diagnostic plots (biomasses, yields, growth curves, diets)<br/>
      • Check if outputs meet skill criteria <br/>
    </td></tr>
  </table>>, width = 10, height=0.3, pos = '0,-10!']
  
  Step_n [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='16'>
    <tr><td bgcolor='lightgray'><b> Pass Skill Criteria? </b></td></tr>
  </table>>, shape = diamond, width = 5, height = 4, pos = '1,-2!']
  
  Step_5 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 5: Dynamical Top-Down Forcing Scenarios</b></td></tr>
    <tr><td bgcolor='white'>
      • Scenario 1: Fishing mortality time series (1970-2010)<br/>
      • Scenario 2: Additional hypothesized predation mortality (1986-2010)
    </td></tr>
  </table>>, pos = '0,-4!']
  
  Step_6 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 6: Run Models with Randomized Interactions</b></td></tr>
    <tr><td bgcolor='white'>
      • Project model simulations (1970-2010) under two scenarios<br/>
      • Run 1000 randomized interaction matrices for each scenario
    </td></tr>
  </table>>, pos = '2,-4!']
  
  Step_7 [label = <<table border='0' cellborder='1' cellspacing='0' cellpadding='8'>
    <tr><td bgcolor='lightgray'><b>Step 7: Assess and Compare Model Skill Metrics</b></td></tr>
    <tr><td bgcolor='white'>
      • Compare scenarios: biomasses, catches, size distribution<br/>
    </td></tr>
  </table>>, width = 10, height=0.3, pos = '1,-6!']
  
  # Connect the nodes vertically
  Step_1 -> Step_2
  Step_2 -> Step_3
  Step_3 -> Step_4
  Step_4 -> Step_n
  
  # Fixed arrows with better routing
  Step_n -> Step_5 [label = 'Yes' fontsize = 35, tailport = 's', headport = 'n']
  
  # Create a better loop back path with adjusted positioning

 Step_n -> Step_3 [fontsize = 35, 
                  constraint = true, 
                  tailport = 'ws', 
                  headport = 's', 
                  minlen = 5, 
                  xlabel = 'No ',
                  splines = 'true',  # Enable curved arrow
                  width = 5,
                  color = 'black']
                  
  Step_5 -> Step_6
  Step_6 -> Step_7
}")

p

```
 

We can now save it as an `svg` image, but first we need to transform from the original HTML format.  
  
```{r, eval = FALSE}

svg_code <- export_svg(p)

# Save as PNG
rsvg_png(charToRaw(svg_code), file = "workflow.png")

# #Save as pdf
# p %>%
#   export_png(
#     file_name = "workflow.png",
#     title = "workflow"
#    )

p %>%
    export_svg %>% charToRaw %>% rsvg_pdf("workflow.jpeg")
```
  

  
  