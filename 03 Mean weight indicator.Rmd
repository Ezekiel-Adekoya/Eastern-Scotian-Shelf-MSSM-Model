---
title: "Mean weight of species for each scenario"
author: "Ezekiel"
date: "2025-03-27"
output: Mean weight of species per scenario
---

Directory Set-up
```{r setup, include=FALSE}
library("here")
library(ggpubr)
library(dplyr)
library(mizer)
library("assertthat")
library("optimParallel")
library("here")
library("tidyr")
library(dplyr)
#library("nloptr")
library(mizerExperimental)
library(tidyverse)
library(mizerHowTo)
library(pbapply)
library(openair)
library(patchwork)

dir <- setwd(here())
knitr::opts_knit$set(root.dir = "~/Mac/Dropbox/Desktop/Eastern Scotian Shelf Model/")

# Define the save directory
save_dir <- paste0(here(), "/Ess_Output/")
```

Extraction of  data
```{r}
biomass_extract <- read.csv("Ess_data/biomass_extract.csv")
yield_extract <- read.csv("Ess_data/yield_extract.csv")
biomass_sim_base<- read.csv("Ess_data/biomass_sim_base.csv")
biomass_sim_opt<- read.csv("Ess_data/biomass_sim_opt.csv")
yield_sim_base<- read.csv("Ess_data/yield_sim_base.csv")
yield_sim_opt<- read.csv("Ess_data/yield_sim_opt.csv")
biomass_ts<-readRDS("Ess_data/biomass_ts.RDS")
biomass_ts<-biomass_ts |> rename(Biomass_Obs=Biomass) 
yield_ts<-readRDS("Ess_data/yield_ts.RDS")
yield_ts<-yield_ts |> rename(Yield_Obs=Yield)
#biomass_cutoff<- read.csv("Ess_data/biomass_cutoff.csv")
```

Get biomass per Scenario
```{r}
sims_scen1 <- readRDS("Ess_output/sims_scen1.RDS")
sims_scen2 <- readRDS("Ess_output/sims_scen2.RDS")
sim_bio<-lapply(sims_scen1,getBiomass,min_w=species_params(params)$biomass_cutoff)
sim_bio2<-lapply(sims_scen2,getBiomass,min_w=species_params(params)$biomass_cutoff)

df_sim_bio<-do.call(rbind.data.frame, sim_bio)
df_sim_bio$sim<-rep(1:100, each=41)
df_sim_bio$year<-rep(1970:2010,100)

df_sim_bio2 <-do.call(rbind.data.frame, sim_bio2)
df_sim_bio2$sim <-rep(1:100, each=41)
df_sim_bio2$year<-rep(1970:2010,100)

```

MeanWeight plot
Data cleaning 
```{r}
# Load and clean biomass per length data
biop <- read.csv("Ess_data/biomass_at_length_DFO_model_spp.csv") %>%
  # Convert data from wide to long format
  pivot_longer(!c(length_cm, YEAR), names_to = "SPECIES", values_to = "BIOMASS") %>%
  # Optional filter: Uncomment to remove lengths < 10 cm
  # filter(length_cm >= 10) %>%
  # Aggregate total biomass by year and species
  group_by(YEAR, SPECIES) %>%
  summarise(BIOMASS = sum(BIOMASS, na.rm = TRUE), .groups = "drop") %>%
  # Convert data back to wide format with species as columns
  pivot_wider(names_from = SPECIES, values_from = BIOMASS) %>%
  ungroup()

# Rename species columns for consistency and clarity
biop <- biop %>%
  rename(
    "AMERICAN PLAICE" = AMERICAN.PLAICE,
    "ATLANTIC COD" = COD.ATLANTIC.,
    "HERRING" = HERRING.ATLANTIC.,
    "ATLANTIC HALIBUT" = ATLANTIC.HALIBUT,
    "REDFISH UNSEPARATED" = REDFISH.UNSEPARATED,
    "GREENLAND HALIBUT" = TURBOT..GREENLAND.HALIBUT,
    "HADDOCK" = HADDOCK,
    "SAND LANCE" = SANDLANCES,
    "SILVER HAKE" = SILVER.HAKE,
    "SPINY DOGFISH" = SPINY.DOGFISH,
    "WHITE HAKE" = WHITE.HAKE,
    "WITCH FLOUNDER" = WITCH.FLOUNDER,
    "YELLOWTAIL FLOUNDER" = YELLOWTAIL.FLOUNDER
  )

# Replace zeros with NA and convert biomass to grams (assuming original is in kg)
biop[, 2:14] <- ifelse(as.matrix(biop[, 2:14]) == 0, "NA", as.matrix(biop[, 2:14]) * 1000)
# Ensure columns are numeric after transformation
biop <- biop %>%
  mutate(across(2:14, as.numeric))

# Load and clean abundance per length data
m <- read.csv("Ess_data/abundance_at_length_DFO_model_spp.csv") %>%
  # Convert from wide to long format
  pivot_longer(!c(length_cm, YEAR), names_to = "SPECIES", values_to = "ABUNDANCE") %>%
  # Optional filter for length
  # filter(length_cm >= 10) %>%
  # Aggregate total abundance by year and species
  group_by(YEAR, SPECIES) %>%
  summarise(ABUNDANCE = sum(ABUNDANCE, na.rm = TRUE), .groups = "drop") %>%
  # Convert to wide format with species as columns
  pivot_wider(names_from = SPECIES, values_from = ABUNDANCE)

# Rename species columns to match those in biomass data
m <- m %>%
  rename(
    "AMERICAN PLAICE" = AMERICAN.PLAICE,
    "ATLANTIC COD" = COD.ATLANTIC.,
    "HERRING" = HERRING.ATLANTIC.,
    "ATLANTIC HALIBUT" = ATLANTIC.HALIBUT,
    "REDFISH UNSEPARATED" = REDFISH.UNSEPARATED,
    "GREENLAND HALIBUT" = TURBOT..GREENLAND.HALIBUT,
    "HADDOCK" = HADDOCK,
    "SAND LANCE" = SANDLANCES,
    "SILVER HAKE" = SILVER.HAKE,
    "SPINY DOGFISH" = SPINY.DOGFISH,
    "WHITE HAKE" = WHITE.HAKE,
    "WITCH FLOUNDER" = WITCH.FLOUNDER,
    "YELLOWTAIL FLOUNDER" = YELLOWTAIL.FLOUNDER
  )

# Replace zeros with NA and keep abundance units as is
m[, 2:14] <- ifelse(as.matrix(m[, 2:14]) == 0, "NA", as.matrix(m[, 2:14]))
# Ensure numeric columns
m <- m %>%
  mutate(across(2:14, as.numeric))

# Store biomass data in a new object for further processing
biomass.p <- biop 

# Identify common species between biomass and abundance datasets
common_species <- intersect(names(biomass.p), names(m))

# Calculate mean weight per individual (grams/individual)
Mean_weight <- biop
#Mean_weight[, c(2:14)] <- biop[, c(2:14)] / m[, c(2:14)]
Mean_weight <- inner_join(biop, m, by = "YEAR", suffix = c("_bio", "_m")) %>%
  mutate(across(ends_with("_bio"), 
                ~ .x / get(sub("_bio", "_m", cur_column())), 
                .names = "{sub('_bio', '', .col)}")) %>%
  select(YEAR, all_of(names(biop)[-1]))
 Mean_weight_by_species <- Mean_weight
#write.csv(Mean_weight_by_species, file = "Ess_data/Mean_weight_by_species.csv", row.names = FALSE)
```


```{r}
getMeanSpeciesWeight<-function(sim, species = NULL,...)
{
    assert_that(is(sim, "MizerSim"))
    species <- valid_species_arg(sim, species)
    n_species <- getN(sim, ...)
    biomass_species <- getBiomass(sim, ...)
   #  n_total <- apply(n_species[, species, drop = FALSE], 1, sum)
   # biomass_total <- apply(biomass_species[, species, drop = FALSE], 
   #      1, sum)
    return(biomass_species/n_species)
}

```


```{r}
# Apply getMeanWeight() to each simulation run for all species
sim_mw1 <- lapply(
  sims_scen1,
  getMeanSpeciesWeight,
  min_w = biomass_cutoff$min_w, 
  max_w = biomass_cutoff$max_w
)

df_sim_1<-do.call(rbind.data.frame, sim_mw1)
df_sim_1$sim<-rep(1:1000, each=41)
df_sim_1$year<-rep(1970:2010,100)
```


```{r}
sim_mw2 <- lapply(
  sims_scen2,
  getMeanSpeciesWeight,
  min_w = biomass_cutoff$min_w, 
  max_w = biomass_cutoff$max_w
)

df_sim_2<-do.call(rbind.data.frame, sim_mw2)
df_sim_2$sim<-rep(1:1000, each=41)
df_sim_2$year<-rep(1970:2010,100)
```


```{r}

sim_mean1<-df_sim_1 |> pivot_longer(c(1:13)) |> mutate(Year=year,Species=as.factor(name)) |> group_by(Species,Year) |>summarise(Mean_weight=median(value))|> ungroup()
sim_lower1<-df_sim_1 |> pivot_longer(c(1:13)) |> mutate(Year=year,Species=as.factor(name)) |> group_by(Species,Year) |>summarise(Mean_weight=min(value))|> ungroup()
sim_upper1<-df_sim_1 |> pivot_longer(c(1:13)) |> mutate(Year=year,Species=as.factor(name)) |> group_by(Species,Year)|>summarise(Mean_weight=max(value))|> ungroup() 


sim_mean2<-df_sim_2 |> pivot_longer(c(1:13)) |> mutate(Year=year,Species=as.factor(name)) |> group_by(Species,Year) |>summarise(Mean_weight=median(value))|> ungroup()
sim_lower2<-df_sim_2 |> pivot_longer(c(1:13)) |> mutate(Year=year,Species=as.factor(name)) |> group_by(Species,Year) |>summarise(Mean_weight=min(value))|> ungroup()
sim_upper2<-df_sim_2 |> pivot_longer(c(1:13)) |> mutate(Year=year,Species=as.factor(name)) |> group_by(Species,Year)|>summarise(Mean_weight=max(value))|> ungroup()
```


```{r}

sim1 <-data.frame(Species=sim_mean1$Species, 
                   Year=sim_mean1$Year,
                   sim_mean=sim_mean1$Mean_weight,
                   sim_lower=sim_lower1$Mean_weight,
                   sim_upper=sim_upper1$Mean_weight,
                   scen=rep("Scen1", length(sim_mean1$Mean_weight)))
sim1 <- sim1 %>%
  mutate(
    Species = fct_recode(Species,
      "ATLANTIC COD" = "COD(ATLANTIC)",
      "HERRING" = "HERRING(ATLANTIC)",
      "GREENLAND HALIBUT" = "TURBOT, GREENLAND HALIBUT",
      "SAND LANCE" = "SANDLANCES"
    ))
    

Mean_weight_obs <- Mean_weight_by_species %>%
  pivot_longer(
    cols = -YEAR,
    names_to = "Species",
    values_to = "Mean_weight"
  ) %>%
  rename(Year = YEAR) %>%
  arrange(Species, Year)

sim1 <-left_join(Mean_weight_obs,sim1)
```

```{r}
sim2 <-data.frame(Species=sim_mean2$Species, 
                   Year=sim_mean2$Year,
                   sim_mean=sim_mean2$Mean_weight,
                   sim_lower=sim_lower2$Mean_weight,
                   sim_upper=sim_upper2$Mean_weight,
                   scen=rep("Scen2", length(sim_mean2$Mean_weight)))
sim2 <- sim2 %>%
  mutate(
    Species = fct_recode(Species,
      "ATLANTIC COD" = "COD(ATLANTIC)",
      "HERRING" = "HERRING(ATLANTIC)",
      "GREENLAND HALIBUT" = "TURBOT, GREENLAND HALIBUT",
      "SAND LANCE" = "SANDLANCES"
    ))

sim2 <-left_join(Mean_weight_obs,sim2)

```

```{r}
time_mw <- rbind(sim1,sim2)
#time_mw <- time_series |> rename(Biomass=Biomass_Obs)

time_mw <- time_mw  %>%
  mutate(scen = ifelse(Year<1986,
                         "Calibration",scen))
species<-levels(time_mw$Species)<- c("AMERICAN PLAICE", "ATLANTIC COD","ATLANTIC HALIBUT", "HERRING","REDFISH UNSEPARATED", "GREENLAND HALIBUT", "HADDOCK","SAND LANCE", "SILVER HAKE", "SPINY DOGFISH",  "WHITE HAKE", "WITCH FLOUNDER", "YELLOWTAIL FLOUNDER")
```


```{r}
time_mw <- time_mw |> arrange(Species) |> mutate(Species=factor(Species,species))

time_mw <- time_mw %>%
  rename(Scenario =  scen )
Mean_weight_plot <- ggplot(time_mw, aes(x = Year, y = Mean_weight, colour = Scenario, fill = Scenario)) +
  facet_wrap(~factor(Species, levels = c("AMERICAN PLAICE", "ATLANTIC COD","ATLANTIC HALIBUT", "HERRING","REDFISH UNSEPARATED", "GREENLAND HALIBUT", "HADDOCK","SAND LANCE", "SILVER HAKE", "SPINY DOGFISH",  "WHITE HAKE", "WITCH FLOUNDER", "YELLOWTAIL FLOUNDER")), scales="free") +
  geom_point(aes(y = Mean_weight), colour = "black", size = 0.5) +
  geom_ribbon(aes(ymin = sim_lower, ymax = sim_upper), alpha = 0.3, colour = NA) +
  geom_line(aes(y = sim_mean)) +
  scale_colour_manual(name = NULL,  # Removes legend title
                      values = c("grey70", "#4575B4", "#D73027"),
                      labels = c("Reference period", "Fishing without additional predation mortality", "Fishing with additional predation mortality")) +
  scale_fill_manual(name = NULL,  # Removes legend title
                    values = c("grey70", "#4575B4", "#D73027"),
                    labels = c("Reference period", "Fishing without additional predation mortality", "Fishing with additional predation mortality")) +
    labs(y = "Individual Mean Body Size (weight, g)", x = "Year") +

  # Add vertical reference line
  geom_vline(xintercept = 1986, linetype = "dashed", color = "black") +

  # Apply clean theme and style customizations
  theme_pubr() +
  theme(
    legend.position = "bottom",
    legend.text = element_text(face = "bold"),
    axis.title.x = element_text(face = "bold"),
    axis.title.y = element_text(face = "bold"),
    strip.text = element_text(face = "bold")
  ) +
  guides(colour = guide_legend(title = NULL), fill = guide_legend(title = NULL))

# Display the plot

  guides(colour = guide_legend(title = NULL), fill = guide_legend(title = NULL))  # Remove legend headings
ggsave(filename = paste0(save_dir, "Mean_weight_plot.jpeg"), plot = Mean_weight_plot,width = 11, height = 7.5, units = "in",dpi = 400)
Mean_weight_plot
```


Calculate spearman correlation across all simulations

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(progress)
mw_sim1 <- sim1 %>%
  select(Year, Species, sim_mean, Mean_weight) %>%
  rename(
    MeanWeight = sim_mean,
    MeanWeight_Obs = Mean_weight)

mw_sim2 <- sim2 %>%
  select(Year, Species, sim_mean, Mean_weight) %>%
  rename(
    MeanWeight = sim_mean,
    MeanWeight_Obs = Mean_weight)

# Prepare species name map
species_name_map <- c(
  "AMERICAN PLAICE" = "AMERICAN PLAICE",
  "COD(ATLANTIC)" = "ATLANTIC COD",
  "HERRING(ATLANTIC)" = "HERRING",
  "ATLANTIC HALIBUT" = "ATLANTIC HALIBUT",
  "REDFISH UNSEPARATED" = "REDFISH UNSEPARATED",
  "TURBOT, GREENLAND HALIBUT" = "GREENLAND HALIBUT",
  "HADDOCK" = "HADDOCK",
  "SANDLANCES" = "SAND LANCE",
  "SILVER HAKE" = "SILVER HAKE",
  "SPINY DOGFISH" = "SPINY DOGFISH",
  "WHITE HAKE" = "WHITE HAKE",
  "WITCH FLOUNDER" = "WITCH FLOUNDER",
  "YELLOWTAIL FLOUNDER" = "YELLOWTAIL FLOUNDER"
)

ggsave(filename = paste0(save_dir, "cor_plot.jpeg"), plot = cor_plot,width = 11, height = 7.5, units = "in",dpi = 400)
```


```{r}
# Initialize correlation data frames
cor_scen1 <- expand.grid(sim = 1:1000, cor_bio = NA, cor_catch = NA, cor_mean = NA)
cor_scen2 <- expand.grid(sim = 1:1000, cor_bio = NA, cor_catch = NA, cor_mean = NA)

# Progress bar
pb <- progress::progress_bar$new(total = 1000)

for (i in 1:1000) {
  pb$tick()

  # === SCENARIO 1 ===
  bio <- plotBiomass(sims_scen1[[i]], return_data = TRUE)
  yield <- sims_scen1[[i]] |> plotYieldGear(return_data = TRUE) |>
    filter(Gear != "Seals", Species != "SANDLANCES")
  yield <- yield_ts %>% left_join(yield, by = c("Year", "Species"))

  sim_model <- sims_scen1[[i]]
  mean_weights <- lapply(unique(species_params(params)$species), function(sp) {
    mean_w <- getMeanWeight(sim_model, species = sp,
                            min_w = species_params(params)$biomass_cutoff[species_params(params)$species == sp],
                            return_data = TRUE)
    data.frame(Year = as.numeric(names(mean_w)), Species = sp, MeanWeight = as.numeric(mean_w))
  }) |> bind_rows()

  mw1 <- mean_weights %>%
    mutate(Species = species_name_map[Species]) %>%
    left_join(mw_sim1 %>% select(Year, Species, MeanWeight_Obs), by = c("Year", "Species")) %>%
    filter(!is.na(MeanWeight), !is.na(MeanWeight_Obs), is.finite(MeanWeight), is.finite(MeanWeight_Obs))

  cor_scen1$cor_bio[i]   <- cor(biomass_ts$Biomass, bio$Biomass, method = "spearman")
  cor_scen1$cor_catch[i] <- cor(yield$Yield_Obs, yield$Yield, method = "spearman", use = "pairwise.complete.obs")
  cor_scen1$cor_mean[i]  <- if (nrow(mw1) > 0) cor(mw1$MeanWeight, mw1$MeanWeight_Obs, method = "spearman", use = "pairwise.complete.obs") else NA

  # === SCENARIO 2 ===
  bio <- plotBiomass(sims_scen2[[i]], return_data = TRUE)
  yield <- sims_scen2[[i]] |> plotYieldGear(return_data = TRUE) |>
    filter(Gear != "Seals", Species != "SANDLANCES")
  yield <- yield_ts %>% left_join(yield, by = c("Year", "Species"))

  sim_model <- sims_scen2[[i]]
  mean_weights <- lapply(unique(species_params(params)$species), function(sp) {
    mean_w <- getMeanWeight(sim_model, species = sp,
                            min_w = species_params(params)$biomass_cutoff[species_params(params)$species == sp],
                            return_data = TRUE)
    data.frame(Year = as.numeric(names(mean_w)), Species = sp, MeanWeight = as.numeric(mean_w))
  }) |> bind_rows()

  mw2 <- mean_weights %>%
    mutate(Species = species_name_map[Species]) %>%
    left_join(mw_sim2 %>% select(Year, Species, MeanWeight_Obs), by = c("Year", "Species")) %>%
    filter(!is.na(MeanWeight), !is.na(MeanWeight_Obs), is.finite(MeanWeight), is.finite(MeanWeight_Obs))

  cor_scen2$cor_bio[i]   <- cor(biomass_ts$Biomass, bio$Biomass, method = "spearman")
  cor_scen2$cor_catch[i] <- cor(yield$Yield_Obs, yield$Yield, method = "spearman", use = "pairwise.complete.obs")
  cor_scen2$cor_mean[i]  <- if (nrow(mw2) > 0) cor(mw2$MeanWeight, mw2$MeanWeight_Obs, method = "spearman", use = "pairwise.complete.obs") else NA
}

# Combine and reformat
cor_scen1$scen <- "Fishing without additional predation mortality"
cor_scen2$scen <- "Fishing with additional predation mortality"

cor_results <- bind_rows(cor_scen1, cor_scen2) %>%
  rename(Biomass = cor_bio, Catch = cor_catch, Mean_weight = cor_mean) %>%
  mutate(cor_mean_overall = rowMeans(select(., Biomass, Catch), na.rm = TRUE))

cor_results_long <- cor_results %>%
  pivot_longer(cols = c("Biomass", "Catch", "Mean_weight"), names_to = "Variable") %>%
  mutate(Variable = ifelse(Variable == "Mean_weight", "Individual Mean body size", Variable))

# Plot
cor_plot <- ggplot(cor_results_long, aes(x = Variable, y = value, fill = scen)) +
  geom_violin(trim = FALSE, scale = "width") +
  theme_bw() +
  labs(x = NULL, y = "Spearman Correlation") +
  scale_fill_manual(values = c(
    "Fishing without additional predation mortality" = "blue",
    "Fishing with additional predation mortality" = "red"
  )) +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 9, face = "bold"),
    axis.text.y = element_text(size = 11, face = "bold"),
    axis.title.y = element_text(size = 11, face = "bold"),
    legend.title = element_blank(),
    legend.text = element_text(size = 10),
    legend.position = "right",
    panel.grid.major = element_blank()
  )

cor_plot
 ggsave(filename = paste0(save_dir, "cor_plot.jpeg"), plot = cor_plot,width = 11, height = 7.5, units = "in",dpi = 400)
```



Comparison of Model Skill Metrics across Model Scenarios
```{r}
# Load necessary library
library(openair)
mw1 <- mw1 %>%
  mutate(scen = "Scen1")
mw1 <- mw1 %>%
  mutate(scen = ifelse(Year<1986,
                       "Calibration",scen))

mw2 <- mw2 %>%
  mutate(scen = "Scen2")
mw2 <- mw2 %>%
  mutate(scen = ifelse(Year<1986,
                       "Calibration",scen))
time_series_mw <- rbind(mw1, mw2)
# Calculate log-transformed observed and simulated mean weights for better statistical comparison
time_series_mw <- time_series_mw %>%
  mutate(
    logMeanWeight = log(MeanWeight_Obs),        # Natural log of observed mean weight
    logSimMeanWeight = log(MeanWeight)          # Natural log of simulated mean weight
  )

# Compute model performance statistics grouped by scenario ("scen")
modStats_mw <- time_series_mw %>%
  group_modify(~modStats(
    .x, 
    obs = "logMeanWeight",                    # Column for observed values (log-transformed)
    mod = "logSimMeanWeight",                 # Column for modelled/simulated values (log-transformed)
    type = "scen",                            # Grouping by scenario
    rank = "scen",                            # Rank by scenario
    statistic = c("n","FAC2","MGE","RMSE","r","COE"),  # Selected performance metrics
    method = "spearman"                       # Use Spearman correlation for "r"
  )) %>%
  ungroup()

# Load flextable for nice formatting of summary table
library(flextable)

# Format the model stats results table
tabl_mw <- modStats_mw %>%
  mutate(across(where(is.numeric), ~round(., 3))) %>%  # Round numeric columns to 3 decimal places
  select(c("scen","n","FAC2","MGE","RMSE","r","COE")) %>%  # Select relevant columns for display
  flextable()  # Convert to flextable for styled tabular output

# Display the formatted table
tabl_mw
```

```{r}

```





